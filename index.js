const templatesB64 = {
  template_body: {
    data: `PHNvYXA6Qm9keSB4bWxuczpzb2FwPSJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy9zb2FwL2Vu
    dmVsb3BlLyIgeG1sbnM6d3N1PSJodHRwOi8vZG9jcy5vYXNpcy1vcGVuLm9yZy93c3MvMjAwNC8w
    MS9vYXNpcy0yMDA0MDEtd3NzLXdzc2VjdXJpdHktdXRpbGl0eS0xLjAueHNkIiB3c3U6SWQ9IlRo
    ZUJvZHkiIHhtbDppZD0iVGhlQm9keSI+CiAgICA8VHJ6YmEgeG1sbnM9Imh0dHA6Ly9mcy5tZmNy
    LmN6L2VldC9zY2hlbWEvdjMiPgogICAgICA8SGxhdmlja2EgQHtkYXRfb2Rlc2x9IEB7b3ZlcmVu
    aX0gQHtwcnZuaV96YXNsYW5pfSBAe3V1aWRfenByYXZ5fT48L0hsYXZpY2thPgogICAgICA8RGF0
    YSBAe2NlbGtfdHJ6YmF9IEB7Y2VycF96dWN0fSBAe2Nlc3Rfc2x1en0gQHtkYW4xfSBAe2RhbjJ9
    IEB7ZGFuM30gQHtkYXRfdHJ6Ynl9IEB7ZGljX3BvcGx9IEB7ZGljX3BvdmVydWppY2lob30gQHtp
    ZF9wb2tsfSBAe2lkX3Byb3Zven0gQHtwb3JhZF9jaXN9IEB7cG91eml0X3pib3oxfSBAe3BvdXpp
    dF96Ym96Mn0gQHtwb3V6aXRfemJvejN9IEB7cmV6aW19IEB7dXJjZW5vX2NlcnBfenVjdH0gQHt6
    YWtsX2RhbjF9IEB7emFrbF9kYW4yfSBAe3pha2xfZGFuM30gQHt6YWtsX25lcG9kbF9kcGh9Pjwv
    RGF0YT4KICAgICAgPEtvbnRyb2xuaUtvZHk+CiAgICAgICAgPHBrcCBjaXBoZXI9IlJTQTIwNDgi
    IGRpZ2VzdD0iU0hBMjU2IiBlbmNvZGluZz0iYmFzZTY0Ij4ke3BrcH08L3BrcD4KICAgICAgICA8
    YmtwIGRpZ2VzdD0iU0hBMSIgZW5jb2Rpbmc9ImJhc2UxNiI+JHtia3B9PC9ia3A+CiAgICAgIDwv
    S29udHJvbG5pS29keT4KICAgIDwvVHJ6YmE+CiAgPC9zb2FwOkJvZHk+`,
    sha1: "3fc3de46f773642c76a00e6a287ff64f6d0f30fb"
  },
  template_request: {
    data: `PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNvYXA6RW52ZWxvcGUgeG1s
    bnM6c29hcD0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvc29hcC9lbnZlbG9wZS8iPgogIDxT
    T0FQLUVOVjpIZWFkZXIgeG1sbnM6U09BUC1FTlY9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3Jn
    L3NvYXAvZW52ZWxvcGUvIj4KICAgIDx3c3NlOlNlY3VyaXR5IHhtbG5zOndzc2U9Imh0dHA6Ly9k
    b2NzLm9hc2lzLW9wZW4ub3JnL3dzcy8yMDA0LzAxL29hc2lzLTIwMDQwMS13c3Mtd3NzZWN1cml0
    eS1zZWNleHQtMS4wLnhzZCIgeG1sbnM6d3N1PSJodHRwOi8vZG9jcy5vYXNpcy1vcGVuLm9yZy93
    c3MvMjAwNC8wMS9vYXNpcy0yMDA0MDEtd3NzLXdzc2VjdXJpdHktdXRpbGl0eS0xLjAueHNkIiBz
    b2FwOm11c3RVbmRlcnN0YW5kPSIxIj4KICAgICAgPHdzc2U6QmluYXJ5U2VjdXJpdHlUb2tlbiBF
    bmNvZGluZ1R5cGU9Imh0dHA6Ly9kb2NzLm9hc2lzLW9wZW4ub3JnL3dzcy8yMDA0LzAxL29hc2lz
    LTIwMDQwMS13c3Mtc29hcC1tZXNzYWdlLXNlY3VyaXR5LTEuMCNCYXNlNjRCaW5hcnkiIFZhbHVl
    VHlwZT0iaHR0cDovL2RvY3Mub2FzaXMtb3Blbi5vcmcvd3NzLzIwMDQvMDEvb2FzaXMtMjAwNDAx
    LXdzcy14NTA5LXRva2VuLXByb2ZpbGUtMS4wI1g1MDl2MyIgd3N1OklkPSJUaGVDZXJ0Ij4ke2Nl
    cnRiNjR9PC93c3NlOkJpbmFyeVNlY3VyaXR5VG9rZW4+CiAgICAgIDxkczpTaWduYXR1cmUgeG1s
    bnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiIElkPSJUaGVTaWduYXR1
    cmUiPgogICAgICAgIDxkczpTaWduZWRJbmZvPgogICAgICAgICAgPGRzOkNhbm9uaWNhbGl6YXRp
    b25NZXRob2QgQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzEwL3htbC1leGMtYzE0
    biMiPgogICAgICAgICAgICA8ZWM6SW5jbHVzaXZlTmFtZXNwYWNlcyB4bWxuczplYz0iaHR0cDov
    L3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiBQcmVmaXhMaXN0PSJzb2FwIi8+CiAg
    ICAgICAgICA8L2RzOkNhbm9uaWNhbGl6YXRpb25NZXRob2Q+CiAgICAgICAgICA8ZHM6U2lnbmF0
    dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1v
    cmUjcnNhLXNoYTI1NiIvPgogICAgICAgICAgPGRzOlJlZmVyZW5jZSBVUkk9IiNUaGVCb2R5Ij4K
    ICAgICAgICAgICAgPGRzOlRyYW5zZm9ybXM+CiAgICAgICAgICAgICAgPGRzOlRyYW5zZm9ybSBB
    bGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIvPgogICAg
    ICAgICAgICA8L2RzOlRyYW5zZm9ybXM+CiAgICAgICAgICAgIDxkczpEaWdlc3RNZXRob2QgQWxn
    b3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTYiLz4KICAgICAg
    ICAgICAgPGRzOkRpZ2VzdFZhbHVlPiR7ZGlnZXN0fTwvZHM6RGlnZXN0VmFsdWU+PCEtLWNvbXB1
    dGVkIGJ5IHhtbGRpZyBlbmdpbmUgLS0+CiAgICAgICAgICA8L2RzOlJlZmVyZW5jZT4KICAgICAg
    ICA8L2RzOlNpZ25lZEluZm8+CiAgICAgICAgPGRzOlNpZ25hdHVyZVZhbHVlPiR7c2lnbmF0dXJl
    fTwvZHM6U2lnbmF0dXJlVmFsdWU+PCEtLWNvbXB1dGVkIGJ5IHhtbGRpZyBlbmdpbmUgLS0+CiAg
    ICAgICAgPGRzOktleUluZm8gSWQ9IlRoZUtleUluZm8iPgogICAgICAgICAgPHdzc2U6U2VjdXJp
    dHlUb2tlblJlZmVyZW5jZSB3c3U6SWQ9IlRoZVNlY3VyaXR5VG9rZW5SZWZlcmVuY2UiPgogICAg
    ICAgICAgICA8d3NzZTpSZWZlcmVuY2UgVVJJPSIjVGhlQ2VydCIgVmFsdWVUeXBlPSJodHRwOi8v
    ZG9jcy5vYXNpcy1vcGVuLm9yZy93c3MvMjAwNC8wMS9vYXNpcy0yMDA0MDEtd3NzLXg1MDktdG9r
    ZW4tcHJvZmlsZS0xLjAjWDUwOXYzIi8+CiAgICAgICAgICA8L3dzc2U6U2VjdXJpdHlUb2tlblJl
    ZmVyZW5jZT4KICAgICAgICA8L2RzOktleUluZm8+CiAgICAgIDwvZHM6U2lnbmF0dXJlPgogICAg
    PC93c3NlOlNlY3VyaXR5PgogIDwvU09BUC1FTlY6SGVhZGVyPgogICR7c29hcF9ib2R5fQo8L3Nv
    YXA6RW52ZWxvcGU+Cg==`,
    sha1: "15cf455af889baae517745120354f917fe09bfcf" 
  },
  template_signature: {
    data: `PGRzOlNpZ25lZEluZm8geG1sbnM6ZHM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNp
    ZyMiIHhtbG5zOnNvYXA9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3NvYXAvZW52ZWxvcGUv
    Ij4KICAgICAgICAgIDxkczpDYW5vbmljYWxpemF0aW9uTWV0aG9kIEFsZ29yaXRobT0iaHR0cDov
    L3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIj4KICAgICAgICAgICAgPGVjOkluY2x1
    c2l2ZU5hbWVzcGFjZXMgeG1sbnM6ZWM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4
    Yy1jMTRuIyIgUHJlZml4TGlzdD0ic29hcCI+PC9lYzpJbmNsdXNpdmVOYW1lc3BhY2VzPgogICAg
    ICAgICAgPC9kczpDYW5vbmljYWxpemF0aW9uTWV0aG9kPgogICAgICAgICAgPGRzOlNpZ25hdHVy
    ZU1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMDQveG1sZHNpZy1tb3Jl
    I3JzYS1zaGEyNTYiPjwvZHM6U2lnbmF0dXJlTWV0aG9kPgogICAgICAgICAgPGRzOlJlZmVyZW5j
    ZSBVUkk9IiNUaGVCb2R5Ij4KICAgICAgICAgICAgPGRzOlRyYW5zZm9ybXM+CiAgICAgICAgICAg
    ICAgPGRzOlRyYW5zZm9ybSBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1s
    LWV4Yy1jMTRuIyI+PC9kczpUcmFuc2Zvcm0+CiAgICAgICAgICAgIDwvZHM6VHJhbnNmb3Jtcz4K
    ICAgICAgICAgICAgPGRzOkRpZ2VzdE1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3Jn
    LzIwMDEvMDQveG1sZW5jI3NoYTI1NiI+PC9kczpEaWdlc3RNZXRob2Q+CiAgICAgICAgICAgIDxk
    czpEaWdlc3RWYWx1ZT4ke2RpZ2VzdH08L2RzOkRpZ2VzdFZhbHVlPgogICAgICAgICAgPC9kczpS
    ZWZlcmVuY2U+CiAgICAgICAgPC9kczpTaWduZWRJbmZvPg==`,
    sha1: "78df1d563048085b2e870e51fd2a56d8571ec1e6"
  }
}

const dataIn = {
	"dat_odesl":"2019-10-31T01:44:45+01:00",
	"prvni_zaslani":"true",
	"uuid_zpravy":"8c13f57e-e250-4fcd-99d8-77b1088d4b84",
	"dic_popl":"CZ00000019",
	"id_provoz":"41",
	"id_pokl":"POKLADNA01",
	"porad_cis":"1",
	"dat_trzby":"2019-10-31T01:44:45+01:00",
	"celk_trzba":"0.00",
	"rezim":"0",
	"overeni":"false",
	"pkp":"",
	"bkp":""
}

const privateKey = `-----BEGIN PRIVATE KEY-----
MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDrVmZ6FE2jYqli
43/LbXZ1vEG8USMRcC/zbGgk5mAoQQKMtF5PIm5i84pd0cPOSRtduNODc7mwjbPK
d5r8p592zNhpei0/XbQcYQ5rpdf0Y84ZNbg9ZmB4nF8YCBy3Gk28YxfW//vIjqvk
uQK6InT4l784gtz/iNAV48ZBkgE/jp+MMii1I+y5EyYkQuRZlCJtOTKdPXECnr5O
rxrGUtbjmF7bBWLD2LXlspZoUOmh4RFfd9WHH8PmcQfij5aJq6cgIB2YENCBHSA1
/HZZEd8vNLv05owb/BOvXj4n86lYJ8tlJVMcorAsrEzVy+XU++78/j9PewL0ft0j
ETHd0U8DAgMBAAECggEBAIqz154oDUI4yiCweQeKsoDdvdih8Ys7ledgg1kMNqxC
9J+9RsBZSLolU+3Lzh3s1KY+Yttc/5phShAQwlYa7U91mC9ChRyNu7PmODuV+Vve
3v/Yu4fkqQMtFpbxYQtCA4L+3HQpV1pzTDh4GnVeDZbeySMjbeFl306nepf216l+
4o2t260RCgC9NU6kybrgrL9mpa2v+0XNugKzjwy3Lv5KUhtTanQm7fOztb8DxvqP
h/j8j504d3SCWTzeGwYWw2lwDZx0wAP0b0fB8oiO9JzHBc+t/R18vS6LaslDmvLi
DM8R0ivySdSJKD5f5CAWlMTkcKkbFblnUhw7KTCH77ECgYEA9+TUwiPf4aZiIzMW
I2Y7AdkF9uwmTzaXZYN+MQycShwfmpOscY+6EL2f2majCGcNEduPB3ZLSgkk1oga
g4Q2VKDyTSMT70FyRGCm/hIHxtWm2KWpUcJ0LKwV3C+XS+v3dI9cEuFeiC2Dv67Y
GLqAnqPUS4Pv8Ed3nLN4zZdONWUCgYEA8wh1FDS9KczhgyzPU+a59blVER0LP7c2
ErXCk815qCsM3aNy1NBFfuyLuChf6XxRvArRibI9TtFlSWq9PKsSWRwgILpS8YxO
g5QA5iJdh5O1L6EGnFmLiw1aUlMJsKmsc2f5klLAacA6ljIFB6A1voeume1Ryozq
wYhO2uLWgEcCgYBBt5pntVb+3TsbFcoCrHFsNfqM0WH+kfxk3w0vN6afRwFh21BV
8sJi+cJNBfSmn5spZsluMwAWqoHnlcFhqEU2/kv+AxSf0vvWAMGEjYceQTmwKYrP
r/tYdG5/Jua3K+E4N2EzaCfFdjt9L37+X0MFy2zWcC3Fx0yAcFvQNRJ4uQKBgHAC
nNtUNz7Vs7YeZ+vWciyjX2aEyVNzYFOdO/GdCQ4N0V8xXtJgrzcBVJ/q09Grv4v4
PHzHDmSOM61zqYYVnl49jT0oQuQa83DHPObUPeEnnaE3CPH0f1D2NYOty9CFUvrZ
l/ftdcsHkrj4ksLh/wMyS7Gb5E+DRQsvhJBzbcMvAoGBAODcoE5dkDH6jPYOkwC5
9cp6olFNc8Mp5+XF3mAMkpiB16lPM/SdolAmuTl+cDF5QJoCAJOMkRAOWJqpPZkw
kG2TVi0t2EQa5xCBbsadl82uKB50+BbViRkaHQUinFDKLZWlUQdjgLT7U1PXza4W
A6ns1H9hLvnZpCRasR6oMVqf
-----END PRIVATE KEY-----
`
const certificateIn = `-----BEGIN CERTIFICATE-----
MIIEmTCCA4GgAwIBAgIFAKCnuv0wDQYJKoZIhvcNAQELBQAwdzESMBAGCgmSJomT
8ixkARkWAkNaMUMwQQYDVQQKDDrEjGVza8OhIFJlcHVibGlrYSDigJMgR2VuZXLD
oWxuw60gZmluYW7EjW7DrSDFmWVkaXRlbHN0dsOtMRwwGgYDVQQDExNFRVQgQ0Eg
MSBQbGF5Z3JvdW5kMB4XDTE5MDgwODE5MjM0MloXDTIyMDgwODE5MjM0MlowQzES
MBAGCgmSJomT8ixkARkWAkNaMRMwEQYDVQQDEwpDWjAwMDAwMDE5MRgwFgYDVQQN
Ew9wcmF2bmlja2Egb3NvYmEwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB
AQDrVmZ6FE2jYqli43/LbXZ1vEG8USMRcC/zbGgk5mAoQQKMtF5PIm5i84pd0cPO
SRtduNODc7mwjbPKd5r8p592zNhpei0/XbQcYQ5rpdf0Y84ZNbg9ZmB4nF8YCBy3
Gk28YxfW//vIjqvkuQK6InT4l784gtz/iNAV48ZBkgE/jp+MMii1I+y5EyYkQuRZ
lCJtOTKdPXECnr5OrxrGUtbjmF7bBWLD2LXlspZoUOmh4RFfd9WHH8PmcQfij5aJ
q6cgIB2YENCBHSA1/HZZEd8vNLv05owb/BOvXj4n86lYJ8tlJVMcorAsrEzVy+XU
++78/j9PewL0ft0jETHd0U8DAgMBAAGjggFeMIIBWjAJBgNVHRMEAjAAMB0GA1Ud
DgQWBBT8zaUMxlfEGXSD/2PZ089ZLGgerTAfBgNVHSMEGDAWgBR8MHaszNaH0ezJ
H+JwCCzjX94MBzAOBgNVHQ8BAf8EBAMCBsAwYwYDVR0gBFwwWjBYBgpghkgBZQMC
ATABMEowSAYIKwYBBQUHAgIwPAw6VGVudG8gY2VydGlmaWvDoXQgYnlsIHZ5ZMOh
biBwb3V6ZSBwcm8gdGVzdG92YWPDrSDDusSNZWx5LjCBlwYDVR0fBIGPMIGMMIGJ
oIGGoIGDhilodHRwOi8vY3JsLmNhMS1wZy5lZXQuY3ovZWV0Y2ExcGcvYWxsLmNy
bIYqaHR0cDovL2NybDIuY2ExLXBnLmVldC5jei9lZXRjYTFwZy9hbGwuY3Jshipo
dHRwOi8vY3JsMy5jYTEtcGcuZWV0LmN6L2VldGNhMXBnL2FsbC5jcmwwDQYJKoZI
hvcNAQELBQADggEBAKVFyv168b/q0X568G+JDvNnz4XVElbJ1r9ro/xv58QP+FD8
PJSR5qxN2F7zKGNYTCee0jSo+XY1KEoSkmeoYHXnQpm7+NG7iUYc2OWu0B3hC/wM
MhNEDtmsTwqSLjgSk6pZTTRXfvtaHf7zvU8iw1PGFhb9m9bJlOfLwoMeFclOpdfo
80pbwRz5t8io/c0lvGodlYj7INHxjlwdwWf3m2mUx4iuKvoAev0ASCdSMDuUWWjY
iMT3PEUqeabeM2dn3xccQ2EhgIcCwhQs2MCA/FDLBbiOt63mUJPJHATIFi/31VKt
z11/Gc434HHsVYB8U/aammSyIfMp6bNE6LhaFe8=
-----END CERTIFICATE-----
`

const encoder = new TextEncoder()
const decoder = new TextDecoder("utf-8")

// https://stackoverflow.com/questions/40031688/javascript-arraybuffer-to-hex
function buf2hex(buffer) { // buffer is an ArrayBuffer
    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
}

// https://stackoverflow.com/questions/105034/create-guid-uuid-in-javascript
function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
}


function pem2derB64(pem){
    return pem.replace(/-----BEGIN [^-]+-----/gm,"").replace(/-----END [^-]+-----/gm,"").replace(/\n/gm,"")
}

function pem2derArr(pem){
    return base64Decode(pem2derB64(pem))
}

/*
https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey#Examples

Import a PEM encoded RSA private key, to use for RSA-PSS signing.
Takes a string containing the PEM encoded key, and returns a Promise
that will resolve to a CryptoKey representing the private key.
*/
function importPrivateKey(pem) {
    const binaryDer = pem2derArr(pem);
 
    return window.crypto.subtle.importKey(
      "pkcs8",
      binaryDer,
      {
        name: "RSASSA-PKCS1-v1_5",
        // Consider using a 4096-bit key for systems that require long-term security
        //modulusLength: 2048,
        //publicExponent: new Uint8Array([1, 0, 1]),
        hash: "SHA-256",
      },
      false,
      ["sign"]
    );
  }

  //https://gist.github.com/jonleighton/958841#gistcomment-1953137
function base64Encode(arrayBuffer) {
    let base64 = '';
    const encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';
  
    const bytes = new Uint8Array(arrayBuffer);
    const byteLength = bytes.byteLength;
    const byteRemainder = byteLength % 3;
    const mainLength = byteLength - byteRemainder;
  
    let a;
    let b;
    let c;
    let d;
    let chunk;
  
    // Main loop deals with bytes in chunks of 3
    for (let i = 0; i < mainLength; i += 3) {
      // Combine the three bytes into a single integer
      chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2];
  
      // Use bitmasks to extract 6-bit segments from the triplet
      a = (chunk & 16515072) >> 18; // 16515072 = (2^6 - 1) << 18
      b = (chunk & 258048) >> 12; // 258048   = (2^6 - 1) << 12
      c = (chunk & 4032) >> 6; // 4032     = (2^6 - 1) << 6
      d = chunk & 63;        // 63       = 2^6 - 1
  
      // Convert the raw binary segments to the appropriate ASCII encoding
      base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d];
    }
  
    // Deal with the remaining bytes and padding
    if (byteRemainder === 1) {
      chunk = bytes[mainLength];
  
      a = (chunk & 252) >> 2; // 252 = (2^6 - 1) << 2
  
      // Set the 4 least significant bits to zero
      b = (chunk & 3) << 4; // 3   = 2^2 - 1
  
      base64 += `${encodings[a]}${encodings[b]}==`;
    } else if (byteRemainder === 2) {
      chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1];
  
      a = (chunk & 64512) >> 10; // 64512 = (2^6 - 1) << 10
      b = (chunk & 1008) >> 4; // 1008  = (2^6 - 1) << 4
  
      // Set the 2 least significant bits to zero
      c = (chunk & 15) << 2; // 15    = 2^4 - 1
  
      base64 += `${encodings[a]}${encodings[b]}${encodings[c]}=`;
    }
  
    return base64;
  }


function base64Decode( string )
{
    var characters = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";
    var outLen = string.length*3/4 - ((string.length - (string.indexOf('=')>=0?string.indexOf('='):string.length))) 
    var result = new ArrayBuffer(outLen)
    var arr = new Uint8Array(result)

    var i = 0;
    var arrIdx = 0;
    do {
        var b1 = characters.indexOf( string.charAt(i++) );
        var b2 = characters.indexOf( string.charAt(i++) );
        var b3 = characters.indexOf( string.charAt(i++) );
        var b4 = characters.indexOf( string.charAt(i++) );

        if (b1<0 || b2<0 || b3<0 || b4<0){
          throw new Error("invalid character found in base64")
        }

        var a = ( ( b1 & 0x3F ) << 2 ) | ( ( b2 >> 4 ) & 0x3 );
        var b = ( ( b2 & 0xF  ) << 4 ) | ( ( b3 >> 2 ) & 0xF );
        var c = ( ( b3 & 0x3  ) << 6 ) | ( b4 & 0x3F );

        if (arrIdx<outLen) arr[arrIdx++]=a
        if (arrIdx<outLen) arr[arrIdx++]=b
        if (arrIdx<outLen) arr[arrIdx++]=c
    } while( i < string.length );
    return result;
}

async function checkHash(name, hash, data){
    const computedArr = await crypto.subtle.digest("SHA-1",data)
    const computed = buf2hex(computedArr)
    if ( computed.toLowerCase() !== hash.toLowerCase() ) throw new Error(`Failed to check hash for ${name} expected: ${hash} computed: ${computed}`)
}

async function loadTemplate(template) {
  const resp = await fetch(template) 
  return await resp.arrayBuffer()
}

async function loadTemplates(){
  const template_body = pem2derArr(templatesB64.template_body.data)
  const template_request = pem2derArr(templatesB64.template_request.data)
  const template_signature = pem2derArr(templatesB64.template_signature.data)
  checkHash(template_body,templatesB64.template_body.sha1)
  checkHash(template_request,templatesB64.template_request.sha1)
  checkHash(template_signature,templatesB64.template_signature.sha1)
  return { template_body, template_request, template_signature}
}

async function generateEetMessage(data, certificate, key){
    const templates  = await loadTemplates()

    //init data
    if (!data.dat_odesl) {
        data.dat_odesl = new Date().toISOString()
    }
    if (!data.dat_trzby) {
        data.dat_trzby = new Date().toISOString()
    }
    if (!data.uuid_zpravy) {
        data.uuid_zpravy = uuidv4();
    } 
    if (!data.dic_popl) throw new Error("chybi polozka dic_popl")
    if (!data.id_provoz) throw new Error("chybi polozka id_provoz")
    if (!data.id_pokl) throw new Error("chybi polozka id_pokl")
    if (!data.porad_cis) throw new Error("chybi polozka porad_cis")
    if (!data.celk_trzba) throw new Error("chybi polozka celk_trzba")

    const pkpInput = `${data["dic_popl"]}|${data["id_provoz"]}|${data["id_pokl"]}|${data["porad_cis"]}|${data["dat_trzby"]}|${data["celk_trzba"]}`
    const pkpInputArr = encoder.encode(pkpInput)
    //console.log(`PKP input: ${pkpInput}`)
    const pkpValueArr = await crypto.subtle.sign("RSASSA-PKCS1-v1_5",key,pkpInputArr)
    const pkpValueB64 = base64Encode(pkpValueArr)
    //console.log(`pkp value: ${pkpValueB64}`)
    data.pkp = pkpValueB64
    data.certb64 = pem2derB64(certificate)

    const pkpHashArr = await crypto.subtle.digest("SHA-1", pkpValueArr)
    const pkpHashHex = buf2hex(pkpHashArr).toUpperCase()
    data.bkp = `${pkpHashHex.slice(0,8)}-${pkpHashHex.slice(8,16)}-${pkpHashHex.slice(16,24)}-${pkpHashHex.slice(24,32)}-${pkpHashHex.slice(32)}`
    //console.log(`pkpHashHex:${pkpHashHex}`)
    //console.log(`bkp:${data.bkp}`)

    // construct body using data values replacement
    let digestFinal = decoder.decode(templates.template_body)
    Object.keys(data).forEach((key)=>{
      //console.log(`digestFinal: ${digestFinal}`)
      digestFinal = digestFinal.replace(`$\{${key}\}`,data[key])
      digestFinal = digestFinal.replace(`@\{${key}\}`,`${key}="${data[key]}"`)
    })
    //remove unused fields
    digestFinal=digestFinal.replace(/\$\{[a-z_0-9:]+\}/gm,"");
    digestFinal=digestFinal.replace(/ @\{[a-z_0-9:]+\}/gm,"");
    //console.log(`digestFinal: ${digestFinal}`)
    data.soap_body = digestFinal

    // compute body digest
    const digestData = encoder.encode(digestFinal)
    const digestValueArr = await crypto.subtle.digest("SHA-256",digestData)
    const digestValue = base64Encode(digestValueArr)
    data.digest = digestValue

    // construct signature using data replacement
    let signatureFinal = decoder.decode(templates.template_signature)
    Object.keys(data).forEach((key)=>{
      signatureFinal = signatureFinal.replace(`$\{${key}\}`,data[key])
      signatureFinal = signatureFinal.replace(`@\{${key}\}`,`${key}="${data[key]}"`)
    })
    //remove unused fields
    signatureFinal=signatureFinal.replace(/\$\{[a-z_0-9:]+\}/gm,"");
    signatureFinal=signatureFinal.replace(/ @\{[a-z_0-9:]+\}/gm,"");
    //console.log(`signatureFinal: ${signatureFinal}`)
    const signatureFinalArr  = encoder.encode(signatureFinal)
    const signatureValue = await crypto.subtle.sign("RSASSA-PKCS1-v1_5", key, signatureFinalArr)
    data.signature = base64Encode(signatureValue)

    // construct final xml file using data replacement
    let xmlFinal = decoder.decode(templates.template_request)
    Object.keys(data).forEach((key)=>{
      xmlFinal = xmlFinal.replace(`$\{${key}\}`,data[key])
      xmlFinal = xmlFinal.replace(`@\{${key}\}`,`${key}="${data[key]}"`)
    })
    //remove unused fields
    xmlFinal=xmlFinal.replace(/\$\{[a-z_0-9:]+\}/gm,"");
    xmlFinal=xmlFinal.replace(/ @\{[a-z_0-9:]+\}/gm,"");
    //console.log(`xmlFinal: ${xmlFinal}`)
    
    return xmlFinal
}

async function send(xmlFinal, pg){
  const url = pg?"https://pg.eet.cz/eet/services/EETServiceSOAP/v3":"https://prod.eet.cz/eet/services/EETServiceSOAP/v3"
  const resp = await fetch(url, {
    method: "POST",
    headers:  {
      "Content-Type": "text/xml;charset=UTF-8",
      "SOAPAction": "http://fs.mfcr.cz/eet/OdeslaniTrzby"
    },
    mode: "no-cors",
    body: xmlFinal
  })

  if (resp.status==200){
    const respBodyArr = await resp.arrayBuffer();
    const respBody = decoder.decode(respBodyArr)
    console.log(`registration result: ${respBody}`)  
  } else {
    console.log(`registration failed ${resp.status}: ${resp.statusText}`)
  }
}

async function main(){
  const key = await importPrivateKey(privateKey)
  const xmlFinal = await generateEetMessage(dataIn, certificateIn, key)
  const resp = await send(xmlFinal, true) //pg send
}

main()
.then(()=>{console.log("PoC done")})
.catch((err)=>{console.error("PoC failed",err)})


